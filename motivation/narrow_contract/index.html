<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.32.4" />
    <meta name="description" content="Describes narrow-contract functions that do not work for all input values, and advantage of using them.">


    <title>Narrow contracts :: Outcome documentation</title>
    <link rel="shortcut icon" href="/outcome/images/favicon.png" type="image/x-icon" />
    <link href="/outcome/css/nucleus.css" rel="stylesheet">
    <link href="/outcome/css/font-awesome.min.css" rel="stylesheet">
    <link href="/outcome/css/hybrid.css" rel="stylesheet">
    <link href="/outcome/css/featherlight.min.css" rel="stylesheet">
    <link href="/outcome/css/horsey.css" rel="stylesheet">
    
    <link href="/outcome/css/theme.css" rel="stylesheet">
    
    
    <link rel="stylesheet" href="/outcome/css/bootstrap.min.css">
    <script src="/outcome/js/jquery-2.x.min.js"></script>
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left {
        display:none !important;
      }
    </style>

    

    <link href="/outcome/css/local.css" rel="stylesheet">

  </head>
  <body class="" data-url="/outcome/motivation/narrow_contract/">
    <nav id="sidebar" class=""><div class="highlightable">
  <div id="header-wrapper">
    <div id="header"> 
	<p>Outcome 2.0 library documentation</p>
 


    </div><div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>
<script type="text/javascript" src="/outcome/js/lunr.min.js"></script>
<script type="text/javascript" src="/outcome/js/horsey.js"></script>
<script type="text/javascript">
    var baseurl = "https:\/\/ned14.github.io\/outcome\/";
</script>
<script type="text/javascript" src="/outcome/js/search.js"></script>

  </div>


    <ul class="topics">
            <li data-nav-id="/outcome/" class="dd-item">
            <a href="/outcome/"><i class="fa fa-fw fa-home"></i></a>
            </li>
    <li data-nav-id="/outcome/requirements/" class="dd-item">
      <a href="/outcome/requirements/">
        <span>Prerequisites</span>
      </a>
    </li>
    <li data-nav-id="/outcome/build/" class="dd-item">
      <a href="/outcome/build/">
        <span>Build and install</span>
      </a>
    </li>
    <li data-nav-id="/outcome/use-matrix/" class="dd-item">
      <a href="/outcome/use-matrix/">
        <span>Decision matrix</span>
      </a>
    </li>
    <li data-nav-id="/outcome/motivation/" class="dd-item parent">
      <a href="/outcome/motivation/">
        <span>Motivation</span>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/motivation/exceptions/" class="dd-item">
        <a href="/outcome/motivation/exceptions/">
          <span>Exceptions</span>
        </a>
    </li>
      <li data-nav-id="/outcome/motivation/errno/" class="dd-item">
        <a href="/outcome/motivation/errno/">
          <span>errno</span>
        </a>
    </li>
      <li data-nav-id="/outcome/motivation/error_codes/" class="dd-item">
        <a href="/outcome/motivation/error_codes/">
          <span>Error codes</span>
        </a>
    </li>
      <li data-nav-id="/outcome/motivation/std_error_code/" class="dd-item">
        <a href="/outcome/motivation/std_error_code/">
          <span>std::error_code</span>
        </a>
    </li>
      <li data-nav-id="/outcome/motivation/plug_error_code/" class="dd-item">
        <a href="/outcome/motivation/plug_error_code/">
          <span>Plugging a library into std::error_code</span>
        </a>
    </li>
      <li data-nav-id="/outcome/motivation/narrow_contract/" class="dd-item active">
        <a href="/outcome/motivation/narrow_contract/">
          <span>Narrow contracts</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/" class="dd-item">
      <a href="/outcome/tutorial/">
        <span>Tutorial</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
    <li data-nav-id="/outcome/tutorial/result/" class="dd-item">
      <a href="/outcome/tutorial/result/">
        <span>result&lt;&gt;</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/result/inspecting/" class="dd-item">
        <a href="/outcome/tutorial/result/inspecting/">
          <span>Inspecting result&lt;T, EC&gt;</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/result/try/" class="dd-item">
        <a href="/outcome/tutorial/result/try/">
          <span>TRY operations</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/outcome/" class="dd-item">
      <a href="/outcome/tutorial/outcome/">
        <span>outcome&lt;&gt;</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/outcome/inspecting/" class="dd-item">
        <a href="/outcome/tutorial/outcome/inspecting/">
          <span>Inspecting outcome&lt;T, EC, EP&gt;</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/no-value/" class="dd-item">
      <a href="/outcome/tutorial/no-value/">
        <span>No-value policies</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/no-value/custom/" class="dd-item">
        <a href="/outcome/tutorial/no-value/custom/">
          <span>A custom no-value policy</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/no-value/builtin/" class="dd-item">
        <a href="/outcome/tutorial/no-value/builtin/">
          <span>Built-in policies</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/payload/" class="dd-item">
      <a href="/outcome/tutorial/payload/">
        <span>Custom payloads</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/payload/copy_file/" class="dd-item">
        <a href="/outcome/tutorial/payload/copy_file/">
          <span>The Filesystem TS</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/payload/copy_file2/" class="dd-item">
        <a href="/outcome/tutorial/payload/copy_file2/">
          <span>Upgrading the Filesystem TS</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/payload/copy_file3/" class="dd-item">
        <a href="/outcome/tutorial/payload/copy_file3/">
          <span>Auto-throwing filesystem_error</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/constructors/" class="dd-item">
      <a href="/outcome/tutorial/constructors/">
        <span>Result returning constructors</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/constructors/two-phase-init/" class="dd-item">
        <a href="/outcome/tutorial/constructors/two-phase-init/">
          <span>Two phase construction</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/constructors/file_handle/" class="dd-item">
        <a href="/outcome/tutorial/constructors/file_handle/">
          <span>A file handle</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/constructors/static-constructor/" class="dd-item">
        <a href="/outcome/tutorial/constructors/static-constructor/">
          <span>Phase 2 construction</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/constructors/metaprogrammg1/" class="dd-item">
        <a href="/outcome/tutorial/constructors/metaprogrammg1/">
          <span>Phase 3</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/constructors/metaprogrammg2/" class="dd-item">
        <a href="/outcome/tutorial/constructors/metaprogrammg2/">
          <span>construct&lt;T&gt;</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/constructors/metaprogrammg3/" class="dd-item">
        <a href="/outcome/tutorial/constructors/metaprogrammg3/">
          <span>Alternatives</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/hooks/" class="dd-item">
      <a href="/outcome/tutorial/hooks/">
        <span>Hooking events</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/hooks/keeping_state/" class="dd-item">
        <a href="/outcome/tutorial/hooks/keeping_state/">
          <span>Keeping state</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/hooks/adl_bridging/" class="dd-item">
        <a href="/outcome/tutorial/hooks/adl_bridging/">
          <span>ADL bridging</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/hooks/hook_result/" class="dd-item">
        <a href="/outcome/tutorial/hooks/hook_result/">
          <span>Hook result</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/hooks/poke_exception/" class="dd-item">
        <a href="/outcome/tutorial/hooks/poke_exception/">
          <span>Custom exception ptr</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/hooks/hook_outcome/" class="dd-item">
        <a href="/outcome/tutorial/hooks/hook_outcome/">
          <span>Hook outcome</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/c-api/" class="dd-item">
      <a href="/outcome/tutorial/c-api/">
        <span>Using result&lt;T&gt; from C code</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/c-api/limitations/" class="dd-item">
        <a href="/outcome/tutorial/c-api/limitations/">
          <span>Limitations</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/c-api/example/" class="dd-item">
        <a href="/outcome/tutorial/c-api/example/">
          <span>Example C&#43;&#43; function</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/c-api/example2/" class="dd-item">
        <a href="/outcome/tutorial/c-api/example2/">
          <span>Calling it from C</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/c-api/variations/" class="dd-item">
        <a href="/outcome/tutorial/c-api/variations/">
          <span>Variations</span>
        </a>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/tutorial/interop/" class="dd-item">
      <a href="/outcome/tutorial/interop/">
        <span>Interoperation</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/tutorial/interop/problem/" class="dd-item">
        <a href="/outcome/tutorial/interop/problem/">
          <span>Incommensurate E types</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/value-or-error/" class="dd-item">
        <a href="/outcome/tutorial/interop/value-or-error/">
          <span>ValueOrError Concept</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/httplib/" class="dd-item">
        <a href="/outcome/tutorial/interop/httplib/">
          <span>The HTTP library</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/tidylib/" class="dd-item">
        <a href="/outcome/tutorial/interop/tidylib/">
          <span>The HTMLTidy library</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/filelib/" class="dd-item">
        <a href="/outcome/tutorial/interop/filelib/">
          <span>The File I/O library</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/app/" class="dd-item">
        <a href="/outcome/tutorial/interop/app/">
          <span>The Application</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/app-map-httplib1/" class="dd-item">
        <a href="/outcome/tutorial/interop/app-map-httplib1/">
          <span>Mapping the HTTP library into the Application 1/2</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/app-map-httplib2/" class="dd-item">
        <a href="/outcome/tutorial/interop/app-map-httplib2/">
          <span>Mapping the HTTP library into the Application 2/2</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/app-map-filelib/" class="dd-item">
        <a href="/outcome/tutorial/interop/app-map-filelib/">
          <span>Mapping the File I/O library into the Application</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/app-map-tidylib/" class="dd-item">
        <a href="/outcome/tutorial/interop/app-map-tidylib/">
          <span>Mapping the HTMLTidy library into the Application</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/app-go/" class="dd-item">
        <a href="/outcome/tutorial/interop/app-go/">
          <span>In use</span>
        </a>
    </li>
      <li data-nav-id="/outcome/tutorial/interop/conclusion/" class="dd-item">
        <a href="/outcome/tutorial/interop/conclusion/">
          <span>Conclusion</span>
        </a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/reference/" class="dd-item">
      <a href="/outcome/reference/">
        <span>API reference</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/reference/outcome/" class="dd-item">
        <a href="/outcome/reference/outcome/">
          <span>outcome&lt;R, S, P&gt;</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/result/" class="dd-item">
        <a href="/outcome/reference/result/">
          <span>result&lt;R, S&gt;</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/try/" class="dd-item">
        <a href="/outcome/reference/try/">
          <span>Try operations</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/success_failure/" class="dd-item">
        <a href="/outcome/reference/success_failure/">
          <span>Success/Failure</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/utils/" class="dd-item">
        <a href="/outcome/reference/utils/">
          <span>Utilities</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/convert/" class="dd-item">
        <a href="/outcome/reference/convert/">
          <span>Interoperation</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/bad_access/" class="dd-item">
        <a href="/outcome/reference/bad_access/">
          <span>Exceptions</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/iostream_support/" class="dd-item">
        <a href="/outcome/reference/iostream_support/">
          <span>iostream support</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/result_c/" class="dd-item">
        <a href="/outcome/reference/result_c/">
          <span>C API</span>
        </a>
    </li>
    <li data-nav-id="/outcome/reference/policies/" class="dd-item">
      <a href="/outcome/reference/policies/">
        <span>Policies</span><i class="fa fa-angle-right fa-lg category-icon"></i>
      </a>
        <ul>
      <li data-nav-id="/outcome/reference/policies/all_narrow/" class="dd-item">
        <a href="/outcome/reference/policies/all_narrow/">
          <span>All narrow (hard UB)</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/policies/outcome_error_code_throw_as_system_error/" class="dd-item">
        <a href="/outcome/reference/policies/outcome_error_code_throw_as_system_error/">
          <span>error_code throw as system_error (Outcome)</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/policies/result_error_code_throw_as_system_error/" class="dd-item">
        <a href="/outcome/reference/policies/result_error_code_throw_as_system_error/">
          <span>error_code throw as system_error (Result)</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/policies/outcome_exception_ptr_rethrow/" class="dd-item">
        <a href="/outcome/reference/policies/outcome_exception_ptr_rethrow/">
          <span>exception_ptr rethrow (Outcome)</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/policies/result_exception_ptr_rethrow/" class="dd-item">
        <a href="/outcome/reference/policies/result_exception_ptr_rethrow/">
          <span>exception_ptr rethrow (Result)</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/policies/terminate/" class="dd-item">
        <a href="/outcome/reference/policies/terminate/">
          <span>Termimate</span>
        </a>
    </li>
      <li data-nav-id="/outcome/reference/policies/throw_bad_result_access/" class="dd-item">
        <a href="/outcome/reference/policies/throw_bad_result_access/">
          <span>Throw bad_result_access</span>
        </a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/outcome/faq/" class="dd-item">
      <a href="/outcome/faq/">
        <span>Frequently asked questions</span>
      </a>
    </li>
    <li data-nav-id="/outcome/videos/" class="dd-item">
      <a href="/outcome/videos/">
        <span>Videos</span>
      </a>
    </li>
    <li data-nav-id="/outcome/changelog/" class="dd-item">
      <a href="/outcome/changelog/">
        <span>Changelog</span>
      </a>
    </li>
    <li data-nav-id="/outcome/history/" class="dd-item">
      <a href="/outcome/history/">
        <span>History</span>
      </a>
    </li>
        <section id="shortcuts">
                <li class="" role=""><h3>More</h3><a href="https://github.com/ned14/outcome" target="_blank" rel="noopener"><i class='fa fa-github'></i> Outcome 2.0 github repo</a></li>
                <li class="" role=""><a href="/outcome/credits" target="_blank" rel="noopener"><i class='fa fa-bullhorn'></i> Acknowledgements</a></li>
        </section>
    </ul>


    <section id="footer"><center>

<a class="github-button" href="https://dedi4.nedprod.com/static/files/outcome-v2.0-source-latest.tar.xz" data-icon="octicon-cloud-download" aria-label="Download Outcome">Download</a>


<a class="github-button" href="https://github.com/ned14/outcome" data-icon="octicon-star" data-show-count="false" aria-label="Star Outcome on GitHub">Star</a>


<a class="github-button" href="https://github.com/ned14/outcome/fork" data-icon="octicon-repo-forked" data-show-count="true" aria-label="Fork Outcome on GitHub">Fork</a>

</center>

<script async defer src="https://buttons.github.io/buttons.js"></script>
    </section>
  </div>
</nav>



        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
        
          <div id="top-bar">
            
              
              
              
            <div id="top-github-link">
              <a class="github-link" href="https://github.com/ned14/outcome/edit/develop/doc/src/content/motivation/narrow_contract.md" target="blank">
                <i class="fa fa-code-fork"></i>
                Edit page
              </a>
            </div><div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                <span id="sidebar-toggle-span">
                  <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                    <i class="fa fa-bars"></i>
                  </a>
                </span>
                <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                <span class="links">
                







 <a href='/outcome/'>Home</a> > <a href='/outcome/motivation/'>Motivation</a> > Narrow contracts

 

 

   
                </span>
            </div>
            <div class="progress">
    <div class="wrapper">

    </div>
</div>

          </div>
        
        
        <div id="body-inner">
          
            <h1>Narrow contracts</h1>
          




<p>A program&rsquo;s thread of execution can enter a &ldquo;disappointing&rdquo; state for two reasons:</p>

<ul>
<li>due to disappointing situation in the environment (operating system, external input),
or</li>
<li>due to a bug in the program.</li>
</ul>

<p>The key to handling these disappointments correctly is to identify to which
category they belong, and use the tools adequate for a given category. In this
tutorial when we say &ldquo;error&rdquo; or &ldquo;failure&rdquo; we only refer to the first category.
A bug is not an error.</p>

<p>A bug is when a program is something else than what it is supposed to be. The
correct action in that case is to change the program so that it is exactly what
it is supposed to be. Unfortunately, sometimes the symptoms of a bug are only
detected when the system is running and at this point no code changes are possible.</p>

<p>In contrast, a failure is when a correct function in a correct program reflects
some disappointing behavior in the environment. The correct action in that case
is for the program to take a control path different than usual, which will likely
cancel some operations and will likely result in different communication with the
outside world.</p>

<p>Symptoms of bugs can sometimes be detected during compilation or static program
analysis or at run-time when observing certain values of objects that are declared
never to be valid at certain points. One classical example is passing a null pointer
to functions that expect a pointer to a valid object:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">int</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="c1">// expects: pi != nullptr
</span><span class="c1"></span><span class="p">{</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>Passing a null pointer where it is not expected is so common a bug that tools
are very good at finding them. For instance, static analyzers will usually detect
it without even executing your code. Similarly, tools like undefined behavior
sanitizers will compile a code as the one above so that a safety check is performed
to check if the pointer is null, and an error message will be logged and program
optionally terminated.</p>

<p>More, compilers can perform optimizations based on undefined behavior caused by
dereferencing a null pointer. In the following code:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">g</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="c1">// expects: pi != nullptr
</span><span class="c1"></span><span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">};</span>
<span class="p">}</span></code></pre></div>
<p>The compiler can see that if <code>pi</code> is null, the program would have undefined
behavior. Since undefined behavior is required by the C++ standard to never
be the programmer&rsquo;s intention, the compiler
assumes that apparently this function is never called with <code>pi == nullptr</code>. If so,
<code>j</code> is always <code>0</code> and the code can be transformed to a faster one:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">g</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="c1">// expects: pi != nullptr
</span><span class="c1"></span><span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">};</span>
<span class="p">}</span></code></pre></div>
<p>Functions like the one above that declare that certain values of input parameters
must not be passed to them are said to have a <em>narrow contract</em>.</p>

<p>Compilers give you non-standard tools to tell them about narrow contracts, so
that they can detect it and make use of it the same way as they are detecting
invalid null pointers. For instance, if a function in your library takes an <code>int</code>
and declares that the value of this <code>int</code> must never be negative. You can use
<code>__builtin_trap()</code> available in GCC and clang:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="nf">h</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="c1">// expects: i &gt;= 0
</span><span class="c1"></span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">__builtin_trap</span><span class="p">();</span>

  <span class="c1">// normal program logic follows ...
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<p>This instruction when hit, causes the program to exit abnormally, which means:
* a debugger can be launched,
* static analyzer can warn you if it can detect a program flow that reaches this
  point,
* UB-sanitizer can log error message when it hits it.</p>

<p>Another tool you could use is <code>__builtin_unreachable()</code>, also available in GCC
and clang:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="nf">h</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="c1">// expects: i &gt;= 0
</span><span class="c1"></span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">__builtin_unreachable</span><span class="p">();</span>

  <span class="c1">// normal program logic follows ...
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<p>This gives a hint to the tools: the programmer guarantees that the program flow
will never reach to the point of executing it. In other words, it is undefined
behavior if control reaches this point. Compiler and other tools can take this
for granted. This way they can deduce that expression <code>i &lt; 0</code> will never be true,
and they can further use this assumption to issue warnings or to optimize the code.
UB-sanitizers can use it to inject a log message and terminate if this point is
nonetheless reached.</p>

<p>Allowing for some input values to be invalid works similarly to cyclic redundancy
checks. It allows for the possibility to observe the symptoms of the bugs (not
the bugs themselves), and if the symptom is revealed the hunt for the bug can start.
This is not only tools that can now easily detect symptoms of bugs, but also
humans during the code review. A reviewer can now say, &ldquo;hey, function <code>h()</code> is
expecting a non-negative value, but this <code>i</code> is actually <code>-1</code>; maybe you wanted
to pass <code>j</code> instead?&ldquo;.</p>


<footer class=" footline" >
	
</footer>




        

      </div>
    </div>

    
 
    

    <div id="navigation">
        <a class="nav nav-prev" href="/outcome/motivation/plug_error_code/" title="Plugging a library into std::error_code"> <i class="fa fa-chevron-left"></i></a>
        <a class="nav nav-next" href="/outcome/tutorial/" title="Tutorial" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>    

    <script src="/outcome/js/clipboard.min.js"></script>
<script src="/outcome/js/featherlight.min.js"></script>
<script src="/outcome/js/html5shiv-printshiv.min.js"></script>


<script src="/outcome/js/modernizr.custom.71422.js"></script>
<script src="/outcome/js/learn.js"></script>
<script src="/outcome/js/hugo-learn.js"></script>


<link href="/outcome/mermaid/mermaid.css" type="text/css" rel="stylesheet"/>
<script src="/outcome/mermaid/mermaid.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
    

  </body>
</html>

